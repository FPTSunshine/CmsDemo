<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head(~{::style})}">
    <style>
        /* Custom styles for noUiSlider */
        #price-slider { height: 10px; }
        .noUi-target { background: #e9ecef; border-radius: 5px; border: none; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
        .noUi-connect { background: linear-gradient(to right, #0d6efd, #0dcaf0); }
        .noUi-handle { border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 5px rgba(0,0,0,0.2); cursor: grab; }
        .noUi-handle:focus { outline: none; }
        .noUi-handle:active { cursor: grabbing; }
        .noUi-handle::before, .noUi-handle::after { display: none; }
        .noUi-tooltip { font-size: 0.8rem; border: none; border-radius: 5px; background: #343a40; color: white; padding: 2px 6px; }
        .order-group-title { font-size: 1.5rem; font-weight: bold; padding: 0.5rem 1rem; border-radius: 0.25rem; color: white; }
        .table th, .table td { vertical-align: middle; }
        .col-order-id { width: 8%; }
        .col-user { width: 20%; }
        .col-date { width: 22%; }
        .col-status { width: 15%; }
        .col-price { width: 15%; }
        .col-actions { width: 10%; }
    </style>
</head>
<body class="main-background d-flex flex-column min-vh-100">

    <div th:replace="~{fragments/layout :: admin-header}"></div>

    <main class="container my-5 flex-grow-1">
        <div class="card content-card shadow">
            <div class="card-header bg-transparent border-bottom-0">
                <h2 class="card-title text-center py-3"><i class="fas fa-receipt me-2"></i>All Orders Management</h2>
            </div>
            <div class="card-body">
                <!-- Filter Form (Phục hồi đầy đủ) -->
                <form th:action="@{/admin/orders}" method="get" class="p-3 bg-light rounded mb-4">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label for="userFilter" class="form-label">Filter by User</label>
                            <select id="userFilter" name="userId" class="form-select">
                                <option value="">All Users</option>
                                <option th:each="user : ${allUsers}" th:value="${user.id}" th:text="${user.username}" th:selected="${param.userId != null and #strings.equals(param.userId[0], user.id)}"></option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="dateFilter" class="form-label">Filter by Date</label>
                            <input type="date" id="dateFilter" name="orderDate" class="form-control" th:value="${param.orderDate != null ? param.orderDate[0] : ''}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Price Range</label>
                            <div id="price-slider" class="mt-3 mb-3"></div>
                            <input type="hidden" name="minPrice" id="minPrice" th:value="${param.minPrice != null ? param.minPrice[0] : '0'}">
                            <input type="hidden" name="maxPrice" id="maxPrice" th:value="${param.maxPrice != null ? param.maxPrice[0] : '100000000'}">
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100">Apply</button>
                            <a th:href="@{/admin/orders}" class="btn btn-secondary w-100 mt-2">Clear</a>
                        </div>
                    </div>
                </form>

                <!-- Bảng cho đơn "Đã đặt" -->
                <div th:if="${not #lists.isEmpty(placedOrders)}">
                    <h3 class="order-group-title bg-warning text-dark my-4">Placed Orders</h3>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light"><tr><th class="text-center col-order-id">Order ID</th><th class="col-user">User</th><th class="col-date">Order Date</th><th class="text-center col-status">Status</th><th class="text-end col-price">Total Price</th><th class="text-center col-actions">Actions</th></tr></thead>
                            <tbody><tr th:each="order : ${placedOrders}"><td class="text-center fw-bold">#<span th:text="${order.id}"></span></td><td><i class="fas fa-user text-muted me-1"></i><span th:text="${order.user.username}"></span></td><td><i class="fas fa-calendar-alt text-muted me-1"></i><span th:text="${#temporals.format(order.orderDate, 'dd-MM-yyyy HH:mm')}"></span></td><td class="text-center"><form th:action="@{/admin/orders/update-status/{id}(id=${order.id})}" method="post"><select name="status" class="form-select form-select-sm" onchange="confirmStatusChange(this)" th:attr="data-old-status=${order.status}" th:classappend="'bg-warning text-dark'"><option value="Placed" selected>Placed</option><option value="Shipping">Shipping</option><option value="Completed">Completed</option></select></form></td><td class="text-end fw-bold text-primary" th:text="${#numbers.formatDecimal(order.totalPrice, 0, 'COMMA', 0, 'POINT')} + ' đ'"></td><td class="text-center"><a th:href="@{/admin/orders/{id}(id=${order.id})}" class="btn btn-sm btn-outline-info" title="View Details"><i class="fas fa-eye"></i></a></td></tr></tbody>
                        </table>
                    </div>
                </div>

                <!-- Bảng cho đơn "Đang giao" -->
                <div th:if="${not #lists.isEmpty(shippingOrders)}">
                    <h3 class="order-group-title bg-primary my-4">Shipping Orders</h3>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light"><tr><th class="text-center col-order-id">Order ID</th><th class="col-user">User</th><th class="col-date">Order Date</th><th class="text-center col-status">Status</th><th class="text-end col-price">Total Price</th><th class="text-center col-actions">Actions</th></tr></thead>
                            <tbody><tr th:each="order : ${shippingOrders}"><td class="text-center fw-bold">#<span th:text="${order.id}"></span></td><td><i class="fas fa-user text-muted me-1"></i><span th:text="${order.user.username}"></span></td><td><i class="fas fa-calendar-alt text-muted me-1"></i><span th:text="${#temporals.format(order.orderDate, 'dd-MM-yyyy HH:mm')}"></span></td><td class="text-center"><form th:action="@{/admin/orders/update-status/{id}(id=${order.id})}" method="post"><select name="status" class="form-select form-select-sm" onchange="confirmStatusChange(this)" th:attr="data-old-status=${order.status}" th:classappend="'bg-primary text-white'"><option value="Placed">Placed</option><option value="Shipping" selected>Shipping</option><option value="Completed">Completed</option></select></form></td><td class="text-end fw-bold text-primary" th:text="${#numbers.formatDecimal(order.totalPrice, 0, 'COMMA', 0, 'POINT')} + ' đ'"></td><td class="text-center"><a th:href="@{/admin/orders/{id}(id=${order.id})}" class="btn btn-sm btn-outline-info" title="View Details"><i class="fas fa-eye"></i></a></td></tr></tbody>
                        </table>
                    </div>
                </div>

                <!-- Bảng cho đơn "Hoàn thành" -->
                <div th:if="${not #lists.isEmpty(completedOrders)}">
                    <h3 class="order-group-title bg-success my-4">Completed Orders</h3>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light"><tr><th class="text-center col-order-id">Order ID</th><th class="col-user">User</th><th class="col-date">Order Date</th><th class="text-center col-status">Status</th><th class="text-end col-price">Total Price</th><th class="text-center col-actions">Actions</th></tr></thead>
                            <tbody><tr th:each="order : ${completedOrders}"><td class="text-center fw-bold">#<span th:text="${order.id}"></span></td><td><i class="fas fa-user text-muted me-1"></i><span th:text="${order.user.username}"></span></td><td><i class="fas fa-calendar-alt text-muted me-1"></i><span th:text="${#temporals.format(order.orderDate, 'dd-MM-yyyy HH:mm')}"></span></td><td class="text-center"><form th:action="@{/admin/orders/update-status/{id}(id=${order.id})}" method="post"><select name="status" class="form-select form-select-sm" onchange="confirmStatusChange(this)" th:attr="data-old-status=${order.status}" th:classappend="'bg-success text-white'"><option value="Placed">Placed</option><option value="Shipping">Shipping</option><option value="Completed" selected>Completed</option></select></form></td><td class="text-end fw-bold text-primary" th:text="${#numbers.formatDecimal(order.totalPrice, 0, 'COMMA', 0, 'POINT')} + ' đ'"></td><td class="text-center"><a th:href="@{/admin/orders/{id}(id=${order.id})}" class="btn btn-sm btn-outline-info" title="View Details"><i class="fas fa-eye"></i></a></td></tr></tbody>
                        </table>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(placedOrders) and #lists.isEmpty(shippingOrders) and #lists.isEmpty(completedOrders)}" class="text-center py-5">
                    <h4>No orders found.</h4>
                </div>
            </div>
        </div>
    </main>

    <div class="mt-auto" th:replace="~{fragments/layout :: footer}"></div>

    <script>
        const priceSlider = document.getElementById('price-slider');
        if (priceSlider) {
            const minPriceInput = document.getElementById('minPrice');
            const maxPriceInput = document.getElementById('maxPrice');
            const moneyFormatter = {
                to: function (value) {
                    if (value >= 1000000) return (Math.round(value / 100000) / 10) + 'tr';
                    return new Intl.NumberFormat('vi-VN').format(value);
                },
                from: function (value) { return Number(String(value).replace(/[\s,trđ]/g, '')); }
            };
            noUiSlider.create(priceSlider, {
                start: [minPriceInput.value, maxPriceInput.value],
                connect: true,
                step: 500000,
                range: { 'min': 0, 'max': 100000000 },
                tooltips: [moneyFormatter, moneyFormatter]
            });
            priceSlider.noUiSlider.on('update', function (values, handle) {
                const rawValues = priceSlider.noUiSlider.get();
                minPriceInput.value = Math.round(rawValues[0]);
                maxPriceInput.value = Math.round(rawValues[1]);
            });
        }

        function confirmStatusChange(selectElement) {
            const oldStatus = selectElement.getAttribute('data-old-status');
            const newStatus = selectElement.value;
            if (oldStatus === newStatus) return;
            const confirmation = confirm(`Are you sure you want to change status from "${oldStatus}" to "${newStatus}"?`);
            if (confirmation) {
                selectElement.form.submit();
            } else {
                selectElement.value = oldStatus;
            }
        }
    </script>
</body>
</html>
